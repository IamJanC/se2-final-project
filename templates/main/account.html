{% extends 'shared/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Your Account - AgriHub Philippines{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/account.css' %}">

<main>
    
    <div class="main-content">
        <div class="user-tab-left">
            
            <!-- Profile Section -->
            <div class="user-profile">
                <div class="profile-pic">
                    {% if user.profile_pic %}
                        <img src="{{ user.profile_pic.url }}" 
                            alt="Profile Picture" 
                            class="profile-picture">
                    {% else %}
                        <span>{{ user.username|first|upper }}</span> <!-- First letter of name -->
                        {% comment %} <img src="{% static 'images/Profile.png' %}" 
                            alt="Default Profile Picture" 
                            class="profile-picture"> {% endcomment %}
                    {% endif %}
                </div>
                <div class="profile-info">
                    <p class="username">{{ user.username }}</p>
                    <a href="#" class="edit-profile">
                        <!-- Edit (pencil) SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" 
                            fill="currentColor" viewBox="0 0 24 24">
                            <path d="M4 21v-3.586l12.293-12.293 
                                    3.586 3.586L7.586 21H4zm14.707-11.707l-3-3 
                                    1.586-1.586a1 1 0 011.414 0l1.586 
                                    1.586a1 1 0 010 1.414L18.707 9.293z"/>
                        </svg>
                        Edit Profile
                    </a>
                </div>
            </div>

            <!-- Navigation Links -->
            <nav class="user-nav">
                <a href="{% url 'main:account' %}" class="nav-link {% if request.resolver_match.url_name == 'account' %}active{% endif %}">
                    <!-- Account SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                        fill="none" stroke="currentColor" stroke-width="2" 
                        viewBox="0 0 24 24">
                        <circle cx="12" cy="7" r="4"/>
                        <path d="M5.5 21a8.38 8.38 0 0113 0"/>
                    </svg>
                    Account
                </a>

                <!-- Temp checkout design-->
                <form method="POST" action="{% url 'orders:my_orders' %}">
                    {% csrf_token %}
                    <button type="submit" class="nav-link {% if request.resolver_match.url_name == 'my_orders' %}active{% endif %}">
                        <!-- Orders SVG -->
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M8 5.00005C7.01165 5.00082 6.49359 5.01338 6.09202 5.21799C5.71569 5.40973 5.40973 5.71569 5.21799 6.09202C5 6.51984 5 7.07989 5 8.2V17.8C5 18.9201 5 19.4802 5.21799 19.908C5.40973 20.2843 5.71569 20.5903 6.09202 20.782C6.51984 21 7.07989 21 8.2 21H15.8C16.9201 21 17.4802 21 17.908 20.782C18.2843 20.5903 18.5903 20.2843 18.782 19.908C19 19.4802 19 18.9201 19 17.8V8.2C19 7.07989 19 6.51984 18.782 6.09202C18.5903 5.71569 18.2843 5.40973 17.908 5.21799C17.5064 5.01338 16.9884 5.00082 16 5.00005M8 5.00005V7H16V5.00005M8 5.00005V4.70711C8 4.25435 8.17986 3.82014 8.5 3.5C8.82014 3.17986 9.25435 3 9.70711 3H14.2929C14.7456 3 15.1799 3.17986 15.5 3.5C15.8201 3.82014 16 4.25435 16 4.70711V5.00005M12 11H9M15 15H9" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                            My Orders
                    </button>
                </form>
            </nav>
        </div>


        <!--Right Side-->
        <div class="order-history-right">
             <!-- Navigation Tabs -->
            <div class="order-tabs">
                <button class="tab active" data-tab="all">Account</button>
                <button class="tab" data-tab="processing">Addresses</button>
            </div>
        
           <!-- Public Profile Section -->
            <div class="account-sections" data-tab-content="all">
                <div class="public-profile section">
                    <h2>Public Profile</h2>
                    
                    <form method="POST" enctype="multipart/form-data" action="/account/">
                        {% csrf_token %}
                        <div class="profile-picture-section">
                            <div class="profile-picture-placeholder">
                                <label for="profile-image">
                                    {% if user.profile_pic %}
                                        <img src="{{ user.profile_pic.url }}" 
                                            alt="Profile Picture" 
                                            class="profile-picture">
                                    {% else %}
                                        <img src="{% static 'images/Profile.png' %}" 
                                            alt="Default Profile Picture" 
                                            class="profile-picture">
                                    {% endif %}
                                </label>
                            </div>
                            
                            <div class="image-upload">
                                <!-- One single hidden input -->
                                <input type="file" id="profile-image" name="profile_pic" accept=".jpeg,.jpg,.png" hidden>

                                <!-- Custom upload button -->
                                <label for="profile-image" class="upload-btn">Select Image</label>

                                <!-- Show chosen filename -->
                                <span id="file-name">No file chosen</span>

                                <div class="file-requirements">
                                    <p>File size: maximum 1 MB</p>
                                    <p>File extension: .JPEG, .PNG</p>
                                </div>
                                
                                <!-- Submit button -->
                                <button type="submit" id="upload-btn" class="upload-btn" style="display:none;">Upload Image</button>
                                <input type="hidden" name="debug" value="form-submitted">
                            </div>
                        </div>
                    </form>

                
                    
                    <div class="gender-section">
                        <label>Gender:</label>
                        <div class="gender-options">
                            <input type="radio" id="male" name="gender" value="male">
                            <label for="male">Male</label>
                            
                            <input type="radio" id="female" name="gender" value="female">
                            <label for="female">Female</label>
                            
                            <input type="radio" id="other" name="gender" value="other">
                            <label for="other">Other</label>
                        </div>
                    </div>
                
                    
                    <div class="date-of-birth-section">
                        <label>Date of Birth: </label>
                        <div class="date-inputs">
                            <select id="dob-month" required>
                                <option value="" disabled selected>Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <input type="number" id="dob-day" placeholder="Day" min="1" max="31" required>
                            <input type="number" id="dob-year" placeholder="Year" min="1930" max="2024" required>
                        </div>
                    </div>
                </div>






                <!-- === PASSWORD === -->
                <div class="div-account-password section">
                    <h2>Password</h2>
                    
                    <div class="password-field">
                        <label for="current-password">Current Password:</label>
                        <div class="password-input-container">
                            <input type="password" id="current-password" name="current-password" minlength="8" maxlength="20">

                            <!-- Eye icons -->
                            <span class="eye-icon" onclick="togglePassword('current-password', this)">
                            <!-- Open eye -->
                            <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>

                            <!-- Closed eye -->
                            <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17.94 17.94A10.05 10.05 0 0112 19c-7 0-11-7-11-7
                                        a20.3 20.3 0 014.48-5.94M9.88 9.88
                                        A3 3 0 0012 15a3 3 0 002.12-5.12M1 1l22 22"/>
                            </svg>
                            </span>
                        </div>
                    </div>

                    
                    <div class="password-field">
                        <label for="new-password">New Password:</label>
                        <div class="password-input-container">
                            <input type="password" id="new-password" name="new-password" minlength="8" maxlength="20">

                            <!-- Eye icons -->
                            <span class="eye-icon" onclick="togglePassword('new-password', this)">
                            <!-- Open eye -->
                            <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>

                            <!-- Closed eye -->
                            <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17.94 17.94A10.05 10.05 0 0112 19c-7 0-11-7-11-7
                                        a20.3 20.3 0 014.48-5.94M9.88 9.88
                                        A3 3 0 0012 15a3 3 0 002.12-5.12M1 1l22 22"/>
                            </svg>
                            </span>
                        </div>
                    </div>


                    
                    <div class="password-field">
                        <label for="confirm-new-password">Confirm New Password:</label>
                        <div class="password-input-container">
                            <input type="password" id="confirm-new-password" name="confirm-new-password" minlength="8" maxlength="20">

                            <!-- Eye icons -->
                            <span class="eye-icon" onclick="togglePassword('confirm-new-password', this)">
                            <!-- Open eye -->
                            <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>

                            <!-- Closed eye -->
                            <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17.94 17.94A10.05 10.05 0 0112 19c-7 0-11-7-11-7
                                        a20.3 20.3 0 014.48-5.94M9.88 9.88
                                        A3 3 0 0012 15a3 3 0 002.12-5.12M1 1l22 22"/>
                            </svg>
                            </span>
                        </div>
                    </div>


                </div>



                <!-- === EMAIL === -->
                <div class="div-account-email section">
                    <h2>Email</h2>
                    
                    <div class="current-email-section">
                        <h6 class="account-email-label">Current email</h6>
                        <p class="current-email-text">{{ user.email }}</p>
                        <div class="email-status">
                            <h6 class="account-email-label">Status</h6>
                            <span class="status-confirmed">Confirmed</span>
                        </div>
                    </div>

                    <div id="divider1">

                    </div>
                    
                    <div class="change-email-section">
                        <h3>Change Your Email</h3>
                        
                        <div class="email-field">
                            <label for="new-email">New Email: </label>
                            <input type="email" id="new-email" name="new-email" minlength="11" maxlength="50">
                        </div>
                        
                        <div class="email-field">
                            <label for="confirm-email">Confirm Email: </label>
                            <input type="email" id="confirm-email" name="confirm-email" minlength="11" maxlength="50">
                        </div>
                        
                        <div class="email-field">
                            <label for="agrihub-password">Your AgriHub Password:</label>
                            <div class="password-input-container">
                                <input type="password" id="agrihub-password" name="agrihub-password" minlength="8" maxlength="20">

                                <!-- Eye icons -->
                                <span class="eye-icon" onclick="togglePassword('agrihub-password', this)">
                                <!-- Open eye -->
                                <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                    fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>

                                <!-- Closed eye -->
                                <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                    fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M17.94 17.94A10.05 10.05 0 0112 19c-7 0-11-7-11-7
                                            a20.3 20.3 0 014.48-5.94M9.88 9.88
                                            A3 3 0 0012 15a3 3 0 002.12-5.12M1 1l22 22"/>
                                </svg>
                                </span>
                            </div>
                        </div>

                        
                        <button type="button" class="change-email-button">Change Email</button>
                    </div>
                </div>
            </div>

            <!-- === ADDRESSES === -->
            <div class="address-section-left">

                <!-- Address Form -->
                <form method="POST" action="{% url 'orders:save_address' %}">
                    {% csrf_token %}
                    <input type="hidden" id="editAddressId" name="edit_address_id" value="">
                    <input type="hidden" name="next" value="{% url 'main:account' %}">
                    <div class="address-forms" style="display: none;">
                        <div class="address-forms-title">
                            <h3>Address Information</h3>
                        </div>

                        <div class="name-form-section">
                            <div class="form-group">
                                <label for="fname">First Name</label>
                                <input type="text" id="fname" name="fname" placeholder="First name" maxlength="20" required>
                            </div>
                            <div class="form-group">
                                <label for="lname">Last Name</label>
                                <input type="text" id="lname" name="lname" placeholder="Last name" maxlength="20" required>
                            </div>
                        </div>

                        <div class="address-form-section-fillable">
                            <div class="form-group">
                                <label for="house">House No./Building/Unit</label>
                                <input type="text" id="house" name="house" placeholder="Blk 4 Lot 5/Unit 2B/Sunshine Bldg" maxlength="20"  required>
                            </div>
                            <div class="form-group">
                                <label for="street">Street</label>
                                <input type="text" id="street" name="street" placeholder="Dahlia Street" maxlength="20" required>
                            </div>
                            <div class="form-group">
                                <label for="label">Label</label>
                                <input type="text" id="label" name="label" placeholder="Home/Work/Friend's" required>
                            </div>
                        </div>

                        <div class="address-form-section-unfillable">
                            <div class="form-group">
                                <label for="barangay">Barangay</label>
                                <input type="text" id="barangay" value="Dalig" disabled>
                            </div>
                            <div class="form-group">
                                <label for="city">City</label>
                                <input type="text" id="city" value="Antipolo" disabled>
                            </div>
                            <div class="form-group">
                                <label for="province">Province</label>
                                <input type="text" id="province" value="Rizal" disabled>
                            </div>
                            <div class="form-group">
                                <label for="zipcode">ZIP Code</label>
                                <input type="text" id="zipcode" value="1870" disabled>
                            </div>
                        </div>

                        <div class="landmark-form-section">
                            <div class="form-group">
                                <label for="landmark">Landmark:</label>
                                <textarea id="landmark" name="landmark"
                                    placeholder="Nearby reference point to help locate your address (e.g. City Hall, Mall, Church)" maxlength="20"></textarea>
                            </div>
                        </div>

                        <div class="contact-form-section">
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="text" id="email" name="email" placeholder="Email Address" minlength="11" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone</label>
                                <input type="text" id="phone" name="phone" placeholder="Phone Number: 09123456789" minlength="11" maxlength="11" required>
                            </div>
                        </div>

                        <div class="form-buttons">
                            <button type="submit" class="btn-save-address-form">Save</button>
                            <button type="button" class="btn-cancel-address-form">Cancel</button>
                        </div>
                    </div>
                </form>

                <!-- Address List -->
                {% if addresses %}
                    <div class="address-selection">
                        <div class="delivery-address">
                            <div class="address-selection-title">
                                <h3>Saved Addresses</h3>
                            </div>
                            {% for addr in addresses %}
                            <div class="address-card">
                                <div class="top-section">
                                    <div class="label-top">
                                        <span class="address-label">{{ addr.label|default:"Address" }}</span>
                                    </div>
                                    <div class="button-modifier-section">
                                        <!-- Edit -->
                                        <button class="modifier-icon-btn" aria-label="Edit" data-id="{{ addr.id }}">
                                            <!-- Example: pencil/edit icon -->
                                            <svg xmlns="http://www.w3.org/2000/svg" 
                                                width="20" height="20" viewBox="0 0 24 24" fill="none" 
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M12 20h9" />
                                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
                                            </svg>
                                            <a class="edit-btn">Edit</a>
                                        </button>
                                        <!-- Delete -->
                                        <button class="modifier-icon-btn" aria-label="Edit" type="button" class="delete-btn" onclick="if (confirm('Are you sure you want to delete this address?')) { window.location='{% url 'orders:delete_address' addr.id %}'; }">
                                            <!-- Example: Trash Icon    -->
                                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M20.5001 6H3.5" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path> <path d="M9.5 11L10 16" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path> <path d="M14.5 11L14 16" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path> <path d="M6.5 6C6.55588 6 6.58382 6 6.60915 5.99936C7.43259 5.97849 8.15902 5.45491 8.43922 4.68032C8.44784 4.65649 8.45667 4.62999 8.47434 4.57697L8.57143 4.28571C8.65431 4.03708 8.69575 3.91276 8.75071 3.8072C8.97001 3.38607 9.37574 3.09364 9.84461 3.01877C9.96213 3 10.0932 3 10.3553 3H13.6447C13.9068 3 14.0379 3 14.1554 3.01877C14.6243 3.09364 15.03 3.38607 15.2493 3.8072C15.3043 3.91276 15.3457 4.03708 15.4286 4.28571L15.5257 4.57697C15.5433 4.62992 15.5522 4.65651 15.5608 4.68032C15.841 5.45491 16.5674 5.97849 17.3909 5.99936C17.4162 6 17.4441 6 17.5 6" stroke="#000000" stroke-width="1.5"></path> <path d="M18.3735 15.3991C18.1965 18.054 18.108 19.3815 17.243 20.1907C16.378 21 15.0476 21 12.3868 21H11.6134C8.9526 21 7.6222 21 6.75719 20.1907C5.89218 19.3815 5.80368 18.054 5.62669 15.3991L5.16675 8.5M18.8334 8.5L18.6334 11.5" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path> </g></svg>
                                            <div class="delete-btn">Delete</div>
                                        </button>
                                    </div>
                                </div>
                                <div class="upper-address-label-section">
                                    <p class="address-card-name">{{ addr.full_name }}</p>
                                </div>
                                <div class="middle-address-section">
                                    <p class="address-card-address">{{ addr.house }}, {{ addr.street }}, Dalig, Antipolo, Rizal 1870</p>
                                    <p class="address-card-landmark">Landmark: {{ addr.landmark }}</p>
                                </div>
                                <div class="lower-address-contact-section">
                                    <p class="address-card-email">{{ addr.email }}</p>
                                    <p class="address-card-phone">{{ addr.phone }}</p>
                                </div>
                                <div class="select-address-buttons">
                                    <button type="button" class="select-address-btn" data-id="{{ addr.id }}">Set as Default</button>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="add-more-address-section">
                                <button type="button" class="add-more-address-btn">➕ Add more address</button>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="address-empty-state">
                        <p>No registered address yet. Please add one.</p>
                        <button type="button" class="add-more-address-btn">Add Address</button>
                    </div>
                {% endif %}
            </div>


        </div>
    </div>
</div>

    
</main>

    <script>

        // For file name
        // Show file name when chosen
        document.getElementById("profile-image").addEventListener("change", function () {
        const fileName = this.files.length > 0 ? this.files[0].name : "No file chosen";
        document.getElementById("file-name").textContent = fileName;
        });

    </script>

    <!--Toggling of password visibility-->
    <script>
        function togglePassword(inputId, iconElement) {
        const input = document.getElementById(inputId);
        const openEye = iconElement.querySelector(".eye-open");
        const closedEye = iconElement.querySelector(".eye-closed");

        if (input.type === "password") {
            input.type = "text";
            openEye.classList.add("hidden");
            closedEye.classList.remove("hidden");
        } else {
            input.type = "password";
            openEye.classList.remove("hidden");
            closedEye.classList.add("hidden");
        }
        }

    </script>

    <script>
        document.getElementById("profile-image").addEventListener("change", function() {
            const fileName = this.files.length > 0 ? this.files[0].name : "No file chosen";
            document.getElementById("file-name").textContent = fileName;
        });
    </script>

    <script>
        document.getElementById('profile-image').addEventListener('change', function() {
            const uploadBtn = document.getElementById('upload-btn');
            if (this.files.length > 0) {
                uploadBtn.style.display = "inline-block";
            } else {
                uploadBtn.style.display = "none";
            }
        });
    </script>

    <script>
        document.querySelectorAll(".order-tabs .tab").forEach(button => {
            button.addEventListener("click", () => {
                // remove active from all tabs
                document.querySelectorAll(".order-tabs .tab").forEach(tab => tab.classList.remove("active"));
                button.classList.add("active");

                // hide all sections with data-tab-content
                document.querySelectorAll("[data-tab-content]").forEach(section => {
                    section.style.display = "none";
                });

                // show the matching section
                const target = button.getAttribute("data-tab");
                document.querySelector(`[data-tab-content="${target}"]`).style.display = "block";
            });
        });

        // show default section
        document.querySelector("[data-tab-content='all']").style.display = "block";
    </script>

    <script>
        const dayInput = document.getElementById("dob-day");
        const yearInput = document.getElementById("dob-year");

        // Restrict Day (always between 1–31)
        dayInput.addEventListener("input", () => {
            if (dayInput.value < 1) dayInput.value = 1;
            if (dayInput.value > 31) dayInput.value = 31;
        });

        // Handle Year Input
        yearInput.addEventListener("input", () => {
            // Limit to 4 digits
            if (yearInput.value.length > 4) {
            yearInput.value = yearInput.value.slice(0, 4);
            }

            // If 4 digits are typed, validate immediately
            if (yearInput.value.length === 4) {
            let value = parseInt(yearInput.value, 10);
            if (value < 1930) yearInput.value = 1930;
            if (value > 2024) yearInput.value = 2024;
            }
        });

        // Validate again when leaving the field
        yearInput.addEventListener("blur", () => {
            if (yearInput.value) {
            let value = parseInt(yearInput.value, 10);
            if (value < 1930) yearInput.value = 1930;
            if (value > 2024) yearInput.value = 2024;
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const formDiv = document.querySelector(".address-forms");
            const selectionDiv = document.querySelector(".address-selection");
            const emptyState = document.querySelector(".address-empty-state");
            const addMoreBtns = document.querySelectorAll(".add-more-address-btn");
            const cancelBtn = document.querySelector(".btn-cancel-address-form");
            const editBtns = document.querySelectorAll(".button-modifier-section .modifier-icon-btn:first-child");

            const showForm = () => {
                formDiv.style.display = "block";
                if (selectionDiv) selectionDiv.style.display = "none";
                if (emptyState) emptyState.style.display = "none";
            };
            const showSelection = () => {
                formDiv.style.display = "none";
                if (selectionDiv) selectionDiv.style.display = "block";
            };

            addMoreBtns.forEach(btn => {
                btn.addEventListener("click", () => {
                    document.getElementById("editAddressId").value = "";
                    ["fname","lname","house","street","label","landmark","email","phone"].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = "";
                    });
                    showForm();
                });
            });

            editBtns.forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    e.preventDefault();
                    const card = btn.closest(".address-card");
                    const addrId = btn.dataset.id;
                    const fullName = card.querySelector(".address-card-name")?.textContent.trim() || "";
                    const [fn = "", ln = ""] = fullName.split(" ");
                    document.getElementById("fname").value = fn;
                    document.getElementById("lname").value = ln;
                    const addrLine = card.querySelector(".address-card-address")?.textContent.split(",") || [];
                    document.getElementById("house").value = (addrLine[0] || "").trim();
                    document.getElementById("street").value = (addrLine[1] || "").trim();
                    document.getElementById("label").value = card.querySelector(".address-label")?.textContent.trim();
                    document.getElementById("landmark").value = card.querySelector(".address-card-landmark")?.textContent.replace("Landmark:","").trim();
                    document.getElementById("email").value = card.querySelector(".address-card-email")?.textContent.trim();
                    document.getElementById("phone").value = card.querySelector(".address-card-phone")?.textContent.trim();
                    document.getElementById("editAddressId").value = addrId;
                    showForm();
                });
            });

            if (cancelBtn) {
                cancelBtn.addEventListener("click", () => {
                    formDiv.style.display = "none";
                    if (selectionDiv) showSelection();
                    else if (emptyState) emptyState.style.display = "block";
                });
            }
        });
    </script>


{% endblock %}