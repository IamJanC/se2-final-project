{% extends 'shared/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Your Account - AgriHub Philippines{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/account.css' %}">

<main>
    
    <div class="main-content">
        <div class="user-tab-left">
            
            <!-- Profile Section -->
            <div class="user-profile">
                <div class="profile-pic">
                    {% if user.profile_pic %}
                        <img src="{{ user.profile_pic.url }}" 
                            alt="Profile Picture" 
                            class="profile-picture">
                    {% else %}
                        <span>{{ user.username|first|upper }}</span> <!-- First letter of name -->
                        {% comment %} <img src="{% static 'images/Profile.png' %}" 
                            alt="Default Profile Picture" 
                            class="profile-picture"> {% endcomment %}
                    {% endif %}
                </div>
                <div class="profile-info">
                    <p class="username">{{ user.username }}</p>
                    <a href="#" class="edit-profile">
                        <!-- Edit (pencil) SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" 
                            fill="currentColor" viewBox="0 0 24 24">
                            <path d="M4 21v-3.586l12.293-12.293 
                                    3.586 3.586L7.586 21H4zm14.707-11.707l-3-3 
                                    1.586-1.586a1 1 0 011.414 0l1.586 
                                    1.586a1 1 0 010 1.414L18.707 9.293z"/>
                        </svg>
                        Edit Profile
                    </a>
                </div>
            </div>

            <!-- Navigation Links -->
            <nav class="user-nav">
                <a href="{% url 'main:account' %}" class="nav-link {% if request.resolver_match.url_name == 'account' %}active{% endif %}">
                    <!-- Account SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                        fill="none" stroke="currentColor" stroke-width="2" 
                        viewBox="0 0 24 24">
                        <circle cx="12" cy="7" r="4"/>
                        <path d="M5.5 21a8.38 8.38 0 0113 0"/>
                    </svg>
                    Account
                </a>

                <!-- Temp checkout design-->
                <form method="POST" action="{% url 'orders:my_orders' %}">
                    {% csrf_token %}
                    <button type="submit" class="nav-link {% if request.resolver_match.url_name == 'my_orders' %}active{% endif %}">
                        <!-- Orders SVG -->
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M8 5.00005C7.01165 5.00082 6.49359 5.01338 6.09202 5.21799C5.71569 5.40973 5.40973 5.71569 5.21799 6.09202C5 6.51984 5 7.07989 5 8.2V17.8C5 18.9201 5 19.4802 5.21799 19.908C5.40973 20.2843 5.71569 20.5903 6.09202 20.782C6.51984 21 7.07989 21 8.2 21H15.8C16.9201 21 17.4802 21 17.908 20.782C18.2843 20.5903 18.5903 20.2843 18.782 19.908C19 19.4802 19 18.9201 19 17.8V8.2C19 7.07989 19 6.51984 18.782 6.09202C18.5903 5.71569 18.2843 5.40973 17.908 5.21799C17.5064 5.01338 16.9884 5.00082 16 5.00005M8 5.00005V7H16V5.00005M8 5.00005V4.70711C8 4.25435 8.17986 3.82014 8.5 3.5C8.82014 3.17986 9.25435 3 9.70711 3H14.2929C14.7456 3 15.1799 3.17986 15.5 3.5C15.8201 3.82014 16 4.25435 16 4.70711V5.00005M12 11H9M15 15H9" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                            My Orders
                    </button>
                </form>
            </nav>
        </div>


        <!--Right Side-->
        <div class="order-history-right">
             <!-- Navigation Tabs -->
            <div class="order-tabs">
                <button class="tab active" data-tab="all">Account</button>
                <button class="tab" data-tab="processing">Addresses</button>
            </div>
        
           <!-- Public Profile Section -->
            <div class="account-sections" data-tab-content="all">
                <div class="public-profile section">
                    <h2>Public Profile</h2>
                    
                    <form method="POST" enctype="multipart/form-data" action="/account/">
                        {% csrf_token %}
                        <div class="profile-picture-section">
                            <div class="profile-picture-placeholder">
                                <label for="profile-image">
                                    {% if user.profile_pic %}
                                        <img src="{{ user.profile_pic.url }}" 
                                            alt="Profile Picture" 
                                            class="profile-picture">
                                    {% else %}
                                        <img src="{% static 'images/Profile.png' %}" 
                                            alt="Default Profile Picture" 
                                            class="profile-picture">
                                    {% endif %}
                                </label>
                            </div>
                            
                            <div class="image-upload">
                                <!-- One single hidden input -->
                                <input type="file" id="profile-image" name="profile_pic" accept=".jpeg,.jpg,.png" hidden>

                                <!-- Custom upload button -->
                                <label for="profile-image" class="upload-btn">Select Image</label>

                                <!-- Show chosen filename -->
                                <span id="file-name">No file chosen</span>

                                <div class="file-requirements">
                                    <p>File size: maximum 1 MB</p>
                                    <p>File extension: .JPEG, .PNG</p>
                                </div>
                                
                                <!-- Submit button -->
                                <button type="submit" id="upload-btn" class="upload-btn" style="display:none;">Upload Image</button>
                                <input type="hidden" name="debug" value="form-submitted">
                            </div>
                        </div>
                    </form>

                
                    
                    <div class="gender-section">
                        <label>Gender:</label>
                        <div class="gender-options">
                            <input type="radio" id="male" name="gender" value="male">
                            <label for="male">Male</label>
                            
                            <input type="radio" id="female" name="gender" value="female">
                            <label for="female">Female</label>
                            
                            <input type="radio" id="other" name="gender" value="other">
                            <label for="other">Other</label>
                        </div>
                    </div>
                
                    
                    <div class="date-of-birth-section">
                        <label>Date of Birth: </label>
                        <div class="date-inputs">
                            <select id="dob-month" required>
                                <option value="" disabled selected>Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <input type="number" id="dob-day" placeholder="Day" min="1" max="31" required>
                            <input type="number" id="dob-year" placeholder="Year" min="1930" max="2024" required>
                        </div>
                    </div>
                </div>






                <!-- === PASSWORD === -->
                <div class="div-account-password section">
                    <h2>Password</h2>
                    
                    <div class="password-field">
                        <label for="current-password">Current Password:</label>
                        <div class="password-input-container">
                            <input type="password" id="current-password" name="current-password" minlength="8" maxlength="20">

                            <!-- Eye icons -->
                            <span class="eye-icon" onclick="togglePassword('current-password', this)">
                            <!-- Open eye -->
                            <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>

                            <!-- Closed eye -->
                            <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17.94 17.94A10.05 10.05 0 0112 19c-7 0-11-7-11-7
                                        a20.3 20.3 0 014.48-5.94M9.88 9.88
                                        A3 3 0 0012 15a3 3 0 002.12-5.12M1 1l22 22"/>
                            </svg>
                            </span>
                        </div>
                    </div>

                    
                    <div class="password-field">
                        <label for="new-password">New Password:</label>
                        <div class="password-input-container">
                            <input type="password" id="new-password" name="new-password" minlength="8" maxlength="20">

                            <!-- Eye icons -->
                            <span class="eye-icon" onclick="togglePassword('new-password', this)">
                            <!-- Open eye -->
                            <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>

                            <!-- Closed eye -->
                            <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17.94 17.94A10.05 10.05 0 0112 19c-7 0-11-7-11-7
                                        a20.3 20.3 0 014.48-5.94M9.88 9.88
                                        A3 3 0 0012 15a3 3 0 002.12-5.12M1 1l22 22"/>
                            </svg>
                            </span>
                        </div>
                    </div>


                    
                <div class="password-field">
                        <label for="confirm-new-password">Confirm New Password:</label>
                        <div class="password-input-container">
                            <input type="password" id="confirm-new-password" name="confirm-new-password" minlength="8" maxlength="20">

                            <!-- Eye icons -->
                            <span class="eye-icon" onclick="togglePassword('confirm-new-password', this)">
                            <!-- Open eye -->
                            <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>

                            <!-- Closed eye -->
                            <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17.94 17.94A10.05 10.05 0 0112 19c-7 0-11-7-11-7
                                        a20.3 20.3 0 014.48-5.94M9.88 9.88
                                        A3 3 0 0012 15a3 3 0 002.12-5.12M1 1l22 22"/>
                            </svg>
                            </span>
                        </div>
                    </div>


                </div>



                <!-- === EMAIL === -->
                <div class="div-account-email section">
                    <h2>Email</h2>
                    
                    <div class="current-email-section">
                        <h6 class="account-email-label">Current email</h6>
                        <p class="current-email-text">{{ user.email }}</p>
                        <div class="email-status">
                            <h6 class="account-email-label">Status</h6>
                            <span class="status-confirmed">Confirmed</span>
                        </div>
                    </div>

                    <div id="divider1">

                    </div>
                    
                    <div class="change-email-section">
                        <h3>Change Your Email</h3>
                        
                        <div class="email-field">
                            <label for="new-email">New Email: </label>
                            <input type="email" id="new-email" name="new-email" minlength="11" maxlength="50">
                        </div>
                        
                        <div class="email-field">
                            <label for="confirm-email">Confirm Email: </label>
                            <input type="email" id="confirm-email" name="confirm-email" minlength="11" maxlength="50">
                        </div>
                        
                        <div class="email-field">
                            <label for="agrihub-password">Your AgriHub Password:</label>
                            <div class="password-input-container">
                                <input type="password" id="agrihub-password" name="agrihub-password" minlength="8" maxlength="20">

                                <!-- Eye icons -->
                                <span class="eye-icon" onclick="togglePassword('agrihub-password', this)">
                                <!-- Open eye -->
                                <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                    fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>

                                <!-- Closed eye -->
                                <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                                    fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M17.94 17.94A10.05 10.05 0 0112 19c-7 0-11-7-11-7
                                            a20.3 20.3 0 014.48-5.94M9.88 9.88
                                            A3 3 0 0012 15a3 3 0 002.12-5.12M1 1l22 22"/>
                                </svg>
                                </span>
                            </div>
                        </div>

                        
                        <button type="button" class="change-email-button">Change Email</button>
                    </div>
                </div>
            </div>

            <!-- === ADDRESSES === -->
            <div class="user-tab-content" id="addresses-section">
                <h2>My Addresses</h2>

                <div class="address-list">
                    {% for address in user.addresses.all %}
                        <div class="address-card">
                            <p><strong>{{ address.full_name }}</strong></p>
                            <p>{{ address.phone }}</p>
                            <p>{{ address.house }} {{ address.street }}</p>
                            <p>{{ address.landmark }}</p>
                            <p>{{ address.label }}</p>

                            <div class="form-buttons">
                                <!-- Edit button -->
                                <form method="post" action="{% url 'orders:save_address' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="id" value="{{ address.id }}">
                                    <input type="hidden" name="next" value="{% url 'account:profile' %}">
                                    <button type="submit">Edit</button>
                                </form>

                                <!-- Delete button -->
                                <form method="post" action="{% url 'orders:delete_address' address.id %}?next={% url 'orders:checkout' %}">
                                    {% csrf_token %}
                                    <button type="submit" class="delete-btn">Delete</button>
                                </form>
                            </div>
                        </div>
                    {% empty %}
                        <p>No addresses saved yet.</p>
                    {% endfor %}
                </div>

                <!-- Add new address form -->
                <div class="address-form">
                    <form method="post" action="{% url 'orders:save_address' %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'orders:checkout' %}">

                        <input type="text" name="full_name" placeholder="Full Name" required>
                        <input type="text" name="phone" placeholder="Phone" required>
                        <input type="email" name="email" placeholder="Email">
                        <input type="text" name="house" placeholder="House">
                        <input type="text" name="street" placeholder="Street">
                        <input type="text" name="landmark" placeholder="Landmark">
                        <input type="text" name="label" placeholder="Label (Home, Work, etc.)">

                        <div class="form-buttons">
                            <button type="submit">Save Address</button>
                        </div>
                    </form>
                </div>
            </div>


        </div>
    </div>
</div>

    
</main>

    <script>

        // For file name
        // Show file name when chosen
        document.getElementById("profile-image").addEventListener("change", function () {
        const fileName = this.files.length > 0 ? this.files[0].name : "No file chosen";
        document.getElementById("file-name").textContent = fileName;
        });

    </script>

    <!--Toggling of password visibility-->
    <script>
        function togglePassword(inputId, iconElement) {
        const input = document.getElementById(inputId);
        const openEye = iconElement.querySelector(".eye-open");
        const closedEye = iconElement.querySelector(".eye-closed");

        if (input.type === "password") {
            input.type = "text";
            openEye.classList.add("hidden");
            closedEye.classList.remove("hidden");
        } else {
            input.type = "password";
            openEye.classList.remove("hidden");
            closedEye.classList.add("hidden");
        }
        }

    </script>

    <script>
        document.getElementById("profile-image").addEventListener("change", function() {
            const fileName = this.files.length > 0 ? this.files[0].name : "No file chosen";
            document.getElementById("file-name").textContent = fileName;
        });
    </script>

    <script>
        document.getElementById('profile-image').addEventListener('change', function() {
            const uploadBtn = document.getElementById('upload-btn');
            if (this.files.length > 0) {
                uploadBtn.style.display = "inline-block";
            } else {
                uploadBtn.style.display = "none";
            }
        });
    </script>

    <script>
        document.querySelectorAll(".order-tabs .tab").forEach(button => {
            button.addEventListener("click", () => {
                // remove active from all tabs
                document.querySelectorAll(".order-tabs .tab").forEach(tab => tab.classList.remove("active"));
                button.classList.add("active");

                // hide all sections with data-tab-content
                document.querySelectorAll("[data-tab-content]").forEach(section => {
                    section.style.display = "none";
                });

                // show the matching section
                const target = button.getAttribute("data-tab");
                document.querySelector(`[data-tab-content="${target}"]`).style.display = "block";
            });
        });

        // show default section
        document.querySelector("[data-tab-content='all']").style.display = "block";
    </script>

    <script>
        const dayInput = document.getElementById("dob-day");
        const yearInput = document.getElementById("dob-year");

        // Restrict Day (always between 1â€“31)
        dayInput.addEventListener("input", () => {
            if (dayInput.value < 1) dayInput.value = 1;
            if (dayInput.value > 31) dayInput.value = 31;
        });

        // Handle Year Input
        yearInput.addEventListener("input", () => {
            // Limit to 4 digits
            if (yearInput.value.length > 4) {
            yearInput.value = yearInput.value.slice(0, 4);
            }

            // If 4 digits are typed, validate immediately
            if (yearInput.value.length === 4) {
            let value = parseInt(yearInput.value, 10);
            if (value < 1930) yearInput.value = 1930;
            if (value > 2024) yearInput.value = 2024;
            }
        });

        // Validate again when leaving the field
        yearInput.addEventListener("blur", () => {
            if (yearInput.value) {
            let value = parseInt(yearInput.value, 10);
            if (value < 1930) yearInput.value = 1930;
            if (value > 2024) yearInput.value = 2024;
            }
        });
    </script>


{% endblock %}