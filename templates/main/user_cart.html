{% extends 'shared/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Your Shopping Cart - AgriHub Philippines{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/user_cart.css' %}">

<main>
    
    <div class="cart-title">
        <h3>Your Cart</h3>

        <!-- Select All Checkbox -->
        <label class="mcui-checkbox select-all-label">
            <input type="checkbox" id="select-all">
            <div>
                <svg class="mcui-check" viewBox="0 0 24 24">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <span class="select-all-text">Select All</span>
        </label>
    </div>

    <section class="main-content">
        <div class="cart-items-left">
            {% for item in cart_items %}
            <div class="cart-item">
                <!-- Product Head -->
                <div class="product-head mcui-checkbox">
                    <!-- Checkbox -->
                    <label>
                          <input type="checkbox" class="select-product" data-item-id="{{ item.id }}">
                        <div>
                            <svg class="mcui-check" viewBox="0 0 24 24">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                    </label>

                    <!-- Delete button -->
                    <button class="delete-btn" aria-label="Delete item" data-item-id="{{ item.id }}">
                        <!-- SVG here -->
                    </button>
                </div>

                <div class="product-detail">
                    <div class="item-picture">
                        <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" class="product-image">
                    </div>

                    <div class="item-details-container">
                        <div class="item-details">
                            <h2 class="product-title">{{ item.product.name }}</h2>
                            <div class="product-description">
                                {{ item.product.description }}
                            </div>
                            <div class="stock-detail">
                                <span class="stock-label {% if item.product.stock > 0 %}in-stock{% else %}out-of-stock{% endif %}">
                                    {% if item.product.stock > 0 %}In Stock{% else %}Out of Stock{% endif %}
                                </span>
                                <p class="product-stock-label">Stock: {{ item.product.stock }}</p>
                                <div class="stock-bar">
                                    <div class="stock-fill filled-stock-bar" style="width: {{ item.product.stock }}%;"></div>
                                </div>
                            </div>

                            <div class="quantity-selector">
                                <button type="button" class="qty-btn minus" aria-label="Decrease quantity" data-item-id="{{ item.id }}">−</button>
                                <input type="number" name="quantity" class="quantity-input" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" data-item-id="{{ item.id }}">
                                <button type="button" class="qty-btn plus" aria-label="Increase quantity" data-item-id="{{ item.id }}">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="product-pricing-container">
                        <p class="product-price" data-item-id="{{ item.id }}">
                            PHP {{ item.subtotal|floatformat:2|intcomma }}
                        </p>

                        <!-- Price per unit -->
                        <p class="product-price-unit" data-item-id="{{ item.id }}" data-unit-price="{{ item.product.price }}">
                            (PHP {{ item.product.price|floatformat:2|intcomma }} per unit)
                        </p>
                    </div>
                </div>
            </div>
            {% empty %}
            <p>Your cart is empty.</p>
            {% endfor %}
        </div>

        <!--  === RIGHT: Order Summary ===  -->
        <div class="order-information-right">
            <!-- Payment Methods Section -->
            <div class="payment-method">
                <h3>Choose your payment method</h3>
                
                <label>
                    <input type="radio" name="payment" value="cod" checked>
                    Cash on Delivery
                </label>
                <br>
    
                <label class="disabled-option">
                    <input type="radio" name="payment" value="gcash" disabled>
                    GCash (Unavailable)
                </label>
                <br>
                
                <label class="disabled-option">
                    <input type="radio" name="payment" value="card" disabled>
                    Credit/Debit Card (Unavailable)
                </label>
            </div>


            <div class="summary-row" id="items-total-group">
                <span>Item(s) Total</span>
                <span>PHP 0.00</span>
            </div>

            <div class="summary-row" id="shop-discount-group">
                <span>Shop Discount</span>
                <span>PHP 0.00</span>
            </div>

            <div class="summary-row divider" id="divider1"></div>

            <div class="summary-row" id="subtotal-group">
                <span>Subtotal</span>
                <span>PHP 0.00</span>
            </div>

            <div class="summary-row" id="shipping-fee-group">
                <span>Shipping Fee</span>
                <span>PHP 0.00</span>
            </div>

            <div class="summary-row divider"></div>

            <div class="summary-row total" id="final-total-group">
                <span>Total (<span id="selected-count">0</span>)</span>
                <span><strong>PHP 0.00</strong></span>
            </div>




            <!-- Checkout Button -->
            <div class="checkout-btn-container">
                <button type="button" class="checkout-btn" id="checkout-btn">Proceed to Checkout</button>
            </div>
        </div>
    </section>
</main>

<!-- Quantity, Select and Calculation Logic -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
    const selectAll = document.getElementById('select-all');
    const productCheckboxes = document.querySelectorAll('.select-product');
    const qtyInputs = document.querySelectorAll('.quantity-input');
    const plusBtns = document.querySelectorAll('.qty-btn.plus');
    const minusBtns = document.querySelectorAll('.qty-btn.minus');

    const DISCOUNT_RATE = 0.20;  // 20% discount like checkout
    const SHIPPING_FEE = 100;     // flat shipping fee

    function recalcTotals() {
        let total = 0;
        let selectedCount = 0;

        document.querySelectorAll('.cart-item').forEach(item => {
            const checkbox = item.querySelector('.select-product');
            if (checkbox.checked) {
                const qtyInput = item.querySelector('.quantity-input');
                const unitPriceEl = item.querySelector('.product-price-unit');
                const qty = parseInt(qtyInput.value) || 1;
                const unitPrice = parseFloat(unitPriceEl.dataset.unitPrice);
                total += qty * unitPrice;
                selectedCount += 1;
            }
        });

        const discount = total * DISCOUNT_RATE;
        const subtotal = Math.max(total - discount, 0);
        const shipping = selectedCount > 0 ? SHIPPING_FEE : 0; // only charge shipping if items selected
        const finalTotal = subtotal + shipping;


        document.querySelector('#items-total-group span:last-child').textContent =
            `PHP ${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
        document.querySelector('#shop-discount-group span:last-child').textContent =
            `PHP ${discount.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
        document.querySelector('#subtotal-group span:last-child').textContent =
            `PHP ${subtotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
        document.querySelector('#shipping-fee-group span:last-child').textContent =
            `PHP ${shipping.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
        
         // ✅ Update selected item count and final total price
        document.getElementById('selected-count').textContent = selectedCount;
        document.querySelector('#final-total-group span strong').textContent =
            `PHP ${finalTotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    }

    function updateSubtotalFrontend(itemId, quantity) {
        const priceEl = document.querySelector(`.product-price[data-item-id="${itemId}"]`);
        const unitPriceEl = document.querySelector(`.product-price-unit[data-item-id="${itemId}"]`);
        const unitPrice = parseFloat(unitPriceEl.dataset.unitPrice);

        // Update subtotal for this item
        const subtotal = unitPrice * quantity;
        priceEl.textContent = `PHP ${subtotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;

        // Recalculate totals considering only checked items
        recalcTotals();
    }

    function sendQuantityUpdate(itemId, quantity) {
        fetch("{% url 'cart:update_cart_item' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 'item_id': itemId, 'quantity': quantity })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) alert(data.message || 'Error updating cart');
        })
        .catch(() => alert('Failed to update cart.'));
    }

    // Quantity events
    qtyInputs.forEach(input => {
        input.addEventListener('input', e => {
            let qty = parseInt(e.target.value) || 1;
            const max = parseInt(e.target.getAttribute('max'), 10);
            if (qty < 1) qty = 1;
            if (max && qty > max) qty = max;
            e.target.value = qty;
            updateSubtotalFrontend(e.target.dataset.itemId, qty);
            sendQuantityUpdate(e.target.dataset.itemId, qty);
        });
    });

    plusBtns.forEach(btn => {
        btn.addEventListener('click', e => {
            const input = btn.parentElement.querySelector('.quantity-input');
            const max = parseInt(input.getAttribute('max'), 10);
            let qty = parseInt(input.value) + 1;
            if (max && qty > max) qty = max; 
            input.value = qty;
            updateSubtotalFrontend(input.dataset.itemId, qty);
            sendQuantityUpdate(input.dataset.itemId, qty);
        });
    });

    minusBtns.forEach(btn => {
        btn.addEventListener('click', e => {
            const input = btn.parentElement.querySelector('.quantity-input');
            let qty = Math.max(parseInt(input.value) - 1, 1);
            input.value = qty;
            updateSubtotalFrontend(input.dataset.itemId, qty);
            sendQuantityUpdate(input.dataset.itemId, qty);
        });
    });

    // Checkbox events
    selectAll.addEventListener('change', () => {
        const checked = selectAll.checked;
        productCheckboxes.forEach(cb => cb.checked = checked);
        recalcTotals();
    });

    productCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
        // Update the selectAll checkbox
        if (!cb.checked) {
            selectAll.checked = false; // Uncheck "Select All" if any checkbox is unchecked
        } else {
            // If all individual checkboxes are checked, check "Select All"
            selectAll.checked = Array.from(productCheckboxes).every(chk => chk.checked);
        }

        recalcTotals(); // Still recalc totals
    });
});

    // Initial totals on page load
    recalcTotals();
});
</script>

<!-- Checkout Button -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const checkoutBtn = document.getElementById('checkout-btn');
    checkoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const selectedIds = Array.from(document.querySelectorAll('.select-product'))
            .filter(cb => cb.checked)
            .map(cb => cb.dataset.itemId);
        if (selectedIds.length === 0) {
            alert('No items selected. Please select at least one item to proceed.');
            return;
        }

        // Redirect to checkout page with selected IDs in query params
        const url = new URL("{% url 'orders:checkout' %}", window.location.origin);
        url.searchParams.append('items', selectedIds.join(','));
        window.location.href = url.toString();
    });
});
</script>



{% endblock %}