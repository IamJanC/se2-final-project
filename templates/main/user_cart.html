{% extends 'shared/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Your Shopping Cart - AgriHub Philippines{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/user_cart.css' %}">

<main>
    
        <div class="cart-title">
            <h3>Your Cart</h3>

            <!-- Select All Checkbox -->
            <label class="mcui-checkbox select-all-label">
                <input type="checkbox" id="select-all">
                <div>
                    <svg class="mcui-check" viewBox="0 0 24 24">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <span class="select-all-text">Select All</span>
            </label>
        </div>

    <section class="main-content">
        <div class="cart-items-left">
            {% for item in cart_items %}
            <div class="cart-item">
                <!-- Product Head -->
                <div class="product-head mcui-checkbox">
                    <!-- Checkbox -->
                    <label>
                          <input type="checkbox" class="select-product" data-item-id="{{ item.id }}">
                        <div>
                            <svg class="mcui-check" viewBox="0 0 24 24">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                    </label>

                    <!-- Delete button -->
                    <button class="delete-btn" aria-label="Delete item" data-item-id="{{ item.id }}">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier">
                        <path d="M20.5001 6H3.5" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path>
                        <path d="M9.5 11L10 16" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path>
                        <path d="M14.5 11L14 16" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path>
                        <path d="M6.5 6C6.55588 6 6.58382 6 6.60915 5.99936C7.43259 5.97849 8.15902 5.45491 8.43922 4.68032C8.44784 4.65649 8.45667 4.62999 8.47434 4.57697L8.57143 4.28571C8.65431 4.03708 8.69575 3.91276 8.75071 3.8072C8.97001 3.38607 9.37574 3.09364 9.84461 3.01877C9.96213 3 10.0932 3 10.3553 3H13.6447C13.9068 3 14.0379 3 14.1554 3.01877C14.6243 3.09364 15.03 3.38607 15.2493 3.8072C15.3043 3.91276 15.3457 4.03708 15.4286 4.28571L15.5257 4.57697C15.5433 4.62992 15.5522 4.65651 15.5608 4.68032C15.841 5.45491 16.5674 5.97849 17.3909 5.99936C17.4162 6 17.4441 6 17.5 6" stroke="#000000" stroke-width="1.5"></path>
                        <path d="M18.3735 15.3991C18.1965 18.054 18.108 19.3815 17.243 20.1907C16.378 21 15.0476 21 12.3868 21H11.6134C8.9526 21 7.6222 21 6.75719 20.1907C5.89218 19.3815 5.80368 18.054 5.62669 15.3991L5.16675 8.5M18.8334 8.5L18.6334 11.5" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path>
                        </g>
                    </svg>
                    </button>
                </div>

                <div class="product-detail">
                    <div class="item-picture">
                        <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" class="product-image">
                    </div>

                    <div class="item-details-container">
                        <div class="item-details">
                            <h2 class="product-title">{{ item.product.name }}</h2>
                            <div class="product-description">
                                {{ item.product.description }}
                            </div>
                            <div class="stock-detail">
                                <span class="stock-label {% if item.product.stock > 0 %}in-stock{% else %}out-of-stock{% endif %}">
                                    {% if item.product.stock > 0 %}In Stock{% else %}Out of Stock{% endif %}
                                </span>
                                <p class="product-stock-label">Stock: {{ item.product.stock }}</p>
                                <div class="stock-bar">
                                    <div class="stock-fill filled-stock-bar" style="width: {{ item.product.stock }}%;"></div>
                                </div>
                            </div>

                            <div class="quantity-selector">
                                <button type="button" class="qty-btn minus" aria-label="Decrease quantity" data-item-id="{{ item.id }}">âˆ’</button>
                                <input type="number" name="quantity" class="quantity-input" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" data-item-id="{{ item.id }}">
                                <button type="button" class="qty-btn plus" aria-label="Increase quantity" data-item-id="{{ item.id }}">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="product-pricing-container">
                        <p class="product-price" data-item-id="{{ item.id }}">
                            PHP {{ item.subtotal|floatformat:2|intcomma }}
                        </p>

                        <!-- Price per unit -->
                        <p class="product-price-unit" data-item-id="{{ item.id }}" data-unit-price="{{ item.product.price }}">
                            (PHP {{ item.product.price|floatformat:2|intcomma }} per unit)
                        </p>
                    </div>
                </div>
            </div>
            {% empty %}
            <p>Your cart is empty.</p>
            {% endfor %}
        </div>

        <!--  === RIGHT: Order Summary ===  -->
        <div class="order-information-right">
            <!-- Payment Methods Section -->
            <div class="payment-method">
                <h3>Choose your payment method</h3>
                
                <label>
                    <input type="radio" name="payment" value="cod" checked>
                    Cash on Delivery
                </label>
                <br>
    
                <label class="disabled-option">
                    <input type="radio" name="payment" value="gcash" disabled>
                    GCash (Unavailable)
                </label>
                <br>
                
                <label class="disabled-option">
                    <input type="radio" name="payment" value="card" disabled>
                    Credit/Debit Card (Unavailable)
                </label>
            </div>


            <div class="summary-row" id="items-total-group">
                <span>Item(s) Total</span>
                <span>PHP 0.00</span>
            </div>

            <div class="summary-row" id="shop-discount-group">
                <span>Shop Discount</span>
                <span>PHP 0.00</span>
            </div>

            <div class="summary-row divider" id="divider1"></div>

            <div class="summary-row" id="subtotal-group">
                <span>Subtotal</span>
                <span>PHP 0.00</span>
            </div>

            <div class="summary-row" id="shipping-fee-group">
                <span>Shipping Fee</span>
                <span>PHP 0.00</span>
            </div>

            <div class="summary-row divider"></div>

            <div class="summary-row total" id="final-total-group">
                <span>Total (<span id="selected-count">0</span>)</span>
                <span><strong>PHP 0.00</strong></span>
            </div>




            <!-- Checkout Button -->
            <div class="checkout-btn-container">
                <button type="button" class="checkout-btn" id="checkout-btn">Proceed to Checkout</button>
            </div>
        </div>
    </section>
</main>

<!-- Stock/Error Modal -->
<div id="stock-modal" class="stock-modal" aria-hidden="true">
    <div class="stock-modal-backdrop" data-modal-close></div>
    <div class="stock-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="stock-modal-title">
        <header class="stock-modal-header">
            <h3 id="stock-modal-title">Notice</h3>
        </header>
        <div class="stock-modal-body">
            <p class="modal-message"></p>
        </div>
        <footer class="stock-modal-footer">
            <button type="button" class="modal-close">OK</button>
        </footer>
    </div>
</div>

<!-- Quantity, Select and Calculation Logic -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
    const selectAll = document.getElementById('select-all');
    const productCheckboxes = document.querySelectorAll('.select-product');
    const qtyInputs = document.querySelectorAll('.quantity-input');
    const plusBtns = document.querySelectorAll('.qty-btn.plus');
    const minusBtns = document.querySelectorAll('.qty-btn.minus');

    const DISCOUNT_RATE = 0.20;  // 20% discount like checkout
    const SHIPPING_FEE = 100;     // flat shipping fee

    function recalcTotals() {
        let total = 0;
        let selectedCount = 0;

        document.querySelectorAll('.cart-item').forEach(item => {
            const checkbox = item.querySelector('.select-product');
            if (checkbox.checked) {
                const qtyInput = item.querySelector('.quantity-input');
                const unitPriceEl = item.querySelector('.product-price-unit');
                const qty = parseInt(qtyInput.value) || 1;
                const unitPrice = parseFloat(unitPriceEl.dataset.unitPrice);
                total += qty * unitPrice;
                selectedCount += 1;
            }
        });

        const discount = total * DISCOUNT_RATE;
        const subtotal = Math.max(total - discount, 0);
        const shipping = selectedCount > 0 ? SHIPPING_FEE : 0; // only charge shipping if items selected
        const finalTotal = subtotal + shipping;


        document.querySelector('#items-total-group span:last-child').textContent =
            `PHP ${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
        document.querySelector('#shop-discount-group span:last-child').textContent =
            `PHP ${discount.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
        document.querySelector('#subtotal-group span:last-child').textContent =
            `PHP ${subtotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
        document.querySelector('#shipping-fee-group span:last-child').textContent =
            `PHP ${shipping.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
        
         // âœ… Update selected item count and final total price
        document.getElementById('selected-count').textContent = selectedCount;
        document.querySelector('#final-total-group span strong').textContent =
            `PHP ${finalTotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    }

    function updateSubtotalFrontend(itemId, quantity) {
        const priceEl = document.querySelector(`.product-price[data-item-id="${itemId}"]`);
        const unitPriceEl = document.querySelector(`.product-price-unit[data-item-id="${itemId}"]`);
        const unitPrice = parseFloat(unitPriceEl.dataset.unitPrice);

        // Update subtotal for this item
        const subtotal = unitPrice * quantity;
        priceEl.textContent = `PHP ${subtotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;

        // Recalculate totals considering only checked items
        recalcTotals();
    }

        function sendQuantityUpdate(itemId, quantity) {
            fetch("{% url 'cart:update_cart_item' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 'item_id': itemId, 'quantity': quantity })
            })
            .then(res => res.json())
            .then(data => {
                // If update fails, show modal and refresh so stock numbers sync
                if (!data.success) showModal(data.message || 'Error updating cart', true);
            })
            .catch(() => showModal('Failed to update cart.', true));
        }

    // Quantity events
    qtyInputs.forEach(input => {
        input.addEventListener('input', e => {
            let qty = parseInt(e.target.value) || 1;
            const max = parseInt(e.target.getAttribute('max'), 10);
            if (qty < 1) qty = 1;
            if (max && qty > max) qty = max;
            e.target.value = qty;
            updateSubtotalFrontend(e.target.dataset.itemId, qty);
            sendQuantityUpdate(e.target.dataset.itemId, qty);
        });
    });

    plusBtns.forEach(btn => {
        btn.addEventListener('click', e => {
            const input = btn.parentElement.querySelector('.quantity-input');
            const max = parseInt(input.getAttribute('max'), 10);
            let qty = parseInt(input.value) + 1;
            if (max && qty > max) qty = max; 
            input.value = qty;
            updateSubtotalFrontend(input.dataset.itemId, qty);
            sendQuantityUpdate(input.dataset.itemId, qty);
        });
    });

    minusBtns.forEach(btn => {
        btn.addEventListener('click', e => {
            const input = btn.parentElement.querySelector('.quantity-input');
            let qty = Math.max(parseInt(input.value) - 1, 1);
            input.value = qty;
            updateSubtotalFrontend(input.dataset.itemId, qty);
            sendQuantityUpdate(input.dataset.itemId, qty);
        });
    });

    // Checkbox events
    selectAll.addEventListener('change', () => {
        const checked = selectAll.checked;
        productCheckboxes.forEach(cb => cb.checked = checked);
        recalcTotals();
    });

    productCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
        // Update the selectAll checkbox
        if (!cb.checked) {
            selectAll.checked = false; // Uncheck "Select All" if any checkbox is unchecked
        } else {
            // If all individual checkboxes are checked, check "Select All"
            selectAll.checked = Array.from(productCheckboxes).every(chk => chk.checked);
        }

        recalcTotals(); // Still recalc totals
    });
});

    // Initial totals on page load
    recalcTotals();
});
</script>

<!-- Checkout Button -->
<script>
// showModal(message, reloadAfter = false)
// - displays a modal with the message
// - if reloadAfter is true, page reloads when modal closed
function showModal(message, reloadAfter = false) {
    let modal = document.getElementById('stock-modal');
    if (!modal) {
        // Safety: fallback to alert if modal not present
        alert(message);
        if (reloadAfter) window.location.reload();
        return;
    }
    modal.querySelector('.modal-message').textContent = message;
    modal.classList.add('visible');
    modal.setAttribute('aria-hidden', 'false');

    const closeBtn = modal.querySelector('.modal-close');
    const backdrop = modal.querySelector('[data-modal-close]');

    function doClose() {
        modal.classList.remove('visible');
        modal.setAttribute('aria-hidden', 'true');
        closeBtn.removeEventListener('click', doClose);
        backdrop.removeEventListener('click', doClose);
        if (reloadAfter) {
            // short delay so user sees the modal close
            setTimeout(() => window.location.reload(), 200);
        }
    }

    closeBtn.addEventListener('click', doClose);
    backdrop.addEventListener('click', doClose);
}
document.addEventListener('DOMContentLoaded', () => {
    const checkoutBtn = document.getElementById('checkout-btn');
    checkoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        const selectedCheckboxes = Array.from(document.querySelectorAll('.select-product'))
            .filter(cb => cb.checked);

        if (selectedCheckboxes.length === 0) {
            alert('No items selected. Please select at least one item to proceed.');
            return;
        }

        // Gather item IDs and quantities
        const selectedItems = selectedCheckboxes.map(cb => {
            const itemId = cb.dataset.itemId;
            const qtyInput = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            return { id: itemId, quantity: parseInt(qtyInput.value, 10) || 1 };
        });

        try {
            const res = await fetch("{% url 'cart:check_stock' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ items: selectedItems })
            });
            const data = await res.json();

            if (!data.success) {
                console.log('Stock check response:', data);
                // Show modal and refresh the page so stock numbers update for the user
                showModal(data.message || 'Some items are out of stock. Please review your cart.', true);
                return;
            }

            // If all good â†’ redirect to checkout
            const selectedIds = selectedItems.map(i => i.id);
            const url = new URL("{% url 'orders:checkout' %}", window.location.origin);
            url.searchParams.append('items', selectedIds.join(','));
            window.location.href = url.toString();
        } catch (err) {
            alert('Error verifying stock. Please try again.');
        }
    });
});
document.addEventListener('DOMContentLoaded', function () {
  const stockModal = document.getElementById('stock-modal');
  if (stockModal) {
    stockModal.classList.remove('visible');
    stockModal.setAttribute('aria-hidden', 'true');
    // ensure CSS hides it (doesn't override display)
    stockModal.style.display = '';
  }
});
</script>



<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const itemId = this.dataset.itemId;
      if (confirm('Are you sure you want to remove this item from your cart?')) {
        fetch("{% url 'cart:delete_cart_item' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ 'item_id': itemId })
        })
        .then(res => res.json())
        .then(data => {
        if (data.success) {
            this.closest('.cart-item').remove();
        } else {
            showModal(data.message || 'Failed to delete item.');
        }
        })
        .catch(() => showModal('Error deleting item.'));
      }
    });
  });
});
</script>

{% endblock %}