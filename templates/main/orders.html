{% extends 'shared/base.html' %}
{% load static %}
{% load humanize %}


{% block title %}My Orders - AgriHub Philippines{% endblock %}


{% block content %}

<link rel="stylesheet" href="{% static 'css/orders.css' %}">

<main>
    <div class="main-content">
        <div class="user-tab-left">
            
            <!-- Profile Section -->
            <div class="user-profile">
                <div class="profile-pic">
                    {% if user.profile_pic %}
                        <img src="{{ user.profile_pic.url }}" 
                            alt="Profile Picture" 
                            class="profile-picture">
                    {% else %}
                        <span>{{ user.username|first|upper }}</span> <!-- First letter of name -->
                        {% comment %} <img src="{% static 'images/Profile.png' %}" 
                            alt="Default Profile Picture" 
                            class="profile-picture"> {% endcomment %}
                    {% endif %}
                    {% comment %} <span>P</span> <!-- First letter of name --> {% endcomment %}
                </div>
                <div class="profile-info">
                    <p class="username">{{ user.username }}</p>
                    <a href="#" class="edit-profile">
                        <!-- Edit (pencil) SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" 
                            fill="currentColor" viewBox="0 0 24 24">
                            <path d="M4 21v-3.586l12.293-12.293 
                                    3.586 3.586L7.586 21H4zm14.707-11.707l-3-3 
                                    1.586-1.586a1 1 0 011.414 0l1.586 
                                    1.586a1 1 0 010 1.414L18.707 9.293z"/>
                        </svg>
                        Edit Profile
                    </a>
                </div>
            </div>

            <!-- Navigation Links -->
            <nav class="user-nav">
                <a href="{% url 'main:account' %}" class="nav-link {% if request.resolver_match.url_name == 'account' %}active{% endif %}">
                    <!-- Account SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                        fill="none" stroke="currentColor" stroke-width="2" 
                        viewBox="0 0 24 24">
                        <circle cx="12" cy="7" r="4"/>
                        <path d="M5.5 21a8.38 8.38 0 0113 0"/>
                    </svg>
                    Account
                </a>
                <!-- Temp checkout design-->
                <form method="POST" action="{% url 'orders:my_orders' %}">
                    {% csrf_token %}
                    <button type="submit" class="nav-link {% if request.resolver_match.url_name == 'my_orders' %}active{% endif %}">
                        <!-- Orders SVG -->
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M8 5.00005C7.01165 5.00082 6.49359 5.01338 6.09202 5.21799C5.71569 5.40973 5.40973 5.71569 5.21799 6.09202C5 6.51984 5 7.07989 5 8.2V17.8C5 18.9201 5 19.4802 5.21799 19.908C5.40973 20.2843 5.71569 20.5903 6.09202 20.782C6.51984 21 7.07989 21 8.2 21H15.8C16.9201 21 17.4802 21 17.908 20.782C18.2843 20.5903 18.5903 20.2843 18.782 19.908C19 19.4802 19 18.9201 19 17.8V8.2C19 7.07989 19 6.51984 18.782 6.09202C18.5903 5.71569 18.2843 5.40973 17.908 5.21799C17.5064 5.01338 16.9884 5.00082 16 5.00005M8 5.00005V7H16V5.00005M8 5.00005V4.70711C8 4.25435 8.17986 3.82014 8.5 3.5C8.82014 3.17986 9.25435 3 9.70711 3H14.2929C14.7456 3 15.1799 3.17986 15.5 3.5C15.8201 3.82014 16 4.25435 16 4.70711V5.00005M12 11H9M15 15H9" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                            My Orders
                    </button>
                </form>
            </nav>



        </div>

        <div class="order-history-right">
             <!-- Navigation Tabs -->
            <div class="order-tabs">
                <button class="tab active" data-tab="all">All ({{ counts.all }})</button>
                <button class="tab" data-tab="processing">Processing ({{ counts.processing }})</button>
                <button class="tab" data-tab="to-ship">To Ship ({{ counts.to_ship }})</button>
                <button class="tab" data-tab="to-receive">To Receive ({{ counts.to_receive }})</button>
                <button class="tab" data-tab="completed">Completed ({{ counts.completed }})</button>
                <button class="tab" data-tab="cancelled">Cancelled ({{ counts.cancelled }})</button>
            </div>

            <!-- Orders Page Search -->
            <form class="orders-search-bar" autocomplete="off">
                <input 
                    class="orders-search__input" 
                    type="text" 
                    placeholder="Search by Order ID, Product, or Date..."
                    maxlength="30" 
                    id="ordersSearchInput"
                >
            </form>


            
            <!-- Orders Content -->
            <div class="orders-container">
                <div class="orders-list" id="all">
                    {% for order in orders %}
                    <div class="order-card" data-status="{{ order.status }}">
                        <div class="order-card-top-section">
                            <h3>{{ order.created_at|date:"F j, Y – g:i A" }}</h3>
                            <span class="order-card-order-status">{{ order.get_status_display }}</span>
                        </div>

                        <div class="order-card-middle-section">
                            <h3>Order ID: #{{ order.id }}</h3>
                        </div>

                        <div class="order-card-total-price">
                            <p class="order-card-product-price">Total: ₱{{ order.total|floatformat:2|intcomma }}</p>
                        </div>

                        <div class="order-card-item-list">
                            <div class="orders-product-header">
                                <div class="product-col">Product</div>
                                <div class="price-col">Price</div>
                                <div class="qty-col">Quantity</div>
                                <div class="subtotal-col">Subtotal</div>
                            </div>
                            {% for item in order.items.all %}
                            <div class="orders-product-row">
                                <div class="product-col product-info">
                                    <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" class="product-img">
                                    <span class="product-name">{{ item.product.name }}</span>
                                </div>
                                <div class="price-col">₱{{ item.price_at_purchase|floatformat:2|intcomma }}</div>
                                <div class="qty-col">x{{ item.quantity }}</div>
                                <div class="subtotal-col">₱{{ item.subtotal|floatformat:2|intcomma }}</div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Buttons -->
                        <div class="order-card-buttons">
                            {% if order.status == "shipped" %}
                                <a href="{% url 'orders:order_received' order.id %}" class="order-btn order-received">Order Received</a>
                                <a href="{% url 'orders:request_return' order.id %}" class="order-btn request-return">Request Return/Refund</a>
                            {% endif %}
                            {% if order.status == "delivered" %}
                                <a href="{% url 'orders:request_return' order.id %}" class="order-btn request-return">Request Return/Refund</a>
                                <button class="order-btn rate-again">Rate Again</button>
                            {% endif %}
                            {% if order.status == "pending" %}
                                <a href="{% url 'orders:cancel_order' order.id %}" class="order-btn cancel-order">Cancel Order</a>
                            {% endif %}
                            <button class="order-btn buy-again">Buy Again</button>
                            <a href="{% url 'orders:order_monitoring' order.id %}" class="order-btn show-details">Show Details</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <p id="noOrdersMessage" class="hidden">No matching orders found.</p>
            </div>







        </div>
    </div>
</main>


<!-- === Scripts === -->

<!-- Script for Toggling Containers -->
<script>
    const statusMap = {
        pending: "processing",
        shipped: "to-ship",
        delivered: "to-receive",
        completed: "completed",
        cancelled: "cancelled"
    };

    // === Get initial tab from URL (if any) ===
    const urlParams = new URLSearchParams(window.location.search);
    let activeTab = urlParams.get("tab") || "all";

    // === Tab Filtering ===
    document.querySelectorAll(".order-tabs .tab").forEach(tab => {
        tab.addEventListener("click", () => {
            // switch active tab
            document.querySelectorAll(".order-tabs .tab").forEach(t => t.classList.remove("active"));
            tab.classList.add("active");
            activeTab = tab.getAttribute("data-tab");

            applyFilters();
        });
    });

    // === Search Filtering ===
    const searchInput = document.getElementById("ordersSearchInput");
    searchInput.addEventListener("input", () => {
        applyFilters();
    });

    // === Combined Filter Function ===
    function applyFilters() {
        const query = searchInput.value.toLowerCase();
        const cards = document.querySelectorAll(".order-card");
        let visibleCount = 0;

        cards.forEach(card => {
            const rawStatus = card.getAttribute("data-status");
            const status = statusMap[rawStatus] || rawStatus;

            // searchable fields
            const orderId = card.querySelector(".order-card-middle-section h3")?.textContent.toLowerCase() || "";
            const orderDate = card.querySelector(".order-card-top-section h3")?.textContent.toLowerCase() || "";
            const productNames = Array.from(card.querySelectorAll(".product-name"))
                                    .map(el => el.textContent.toLowerCase())
                                    .join(" ");

            const matchesSearch = orderId.includes(query) || orderDate.includes(query) || productNames.includes(query);
            const matchesTab = (activeTab === "all" || status === activeTab);

            if (matchesSearch && matchesTab) {
                card.style.display = "block";
                visibleCount++;
            } else {
                card.style.display = "none";
            }
        });

        // === Toggle "No matching orders" message ===
        const noOrdersMsg = document.getElementById("noOrdersMessage");
        if (visibleCount === 0) {
            let tabLabel;
            switch (activeTab) {
                case "processing": tabLabel = "Processing"; break;
                case "to-ship": tabLabel = "To Ship"; break;
                case "to-receive": tabLabel = "To Receive"; break;
                case "completed": tabLabel = "Completed"; break;
                case "cancelled": tabLabel = "Cancelled"; break;
                default: tabLabel = ""; // covers "all"
            }

            if (query) {
                noOrdersMsg.textContent = `No ${tabLabel} Orders match your search.`;
            } else {
                noOrdersMsg.textContent = `No ${tabLabel} Orders found.`;
            }

            noOrdersMsg.classList.remove("hidden");
        } else {
            noOrdersMsg.classList.add("hidden");
        }
    }

    // === Activate correct tab on page load ===
    document.querySelectorAll(".order-tabs .tab").forEach(tab => {
        if (tab.getAttribute("data-tab") === activeTab) {
            tab.classList.add("active");
        } else {
            tab.classList.remove("active");
        }
    });

    // Run filter once on load
    applyFilters();

</script>



{% endblock %}